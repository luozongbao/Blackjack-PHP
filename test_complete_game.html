<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Blackjack Game Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        .game-frame { border: 2px solid #ccc; height: 600px; width: 100%; }
        .log { background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 300px; overflow-y: auto; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Complete Blackjack Game Test</h1>
    
    <div id="status" class="status info">
        Ready to test. Follow the steps below in order.
    </div>
    
    <div class="test-section">
        <h2>Step 1: Authentication Setup</h2>
        <button onclick="setupAuth()">Setup Authentication</button>
        <div id="auth-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Step 2: Load Game Page</h2>
        <button onclick="loadGamePage()">Load Game in Frame</button>
        <iframe id="game-frame" class="game-frame" src="about:blank"></iframe>
    </div>
    
    <div class="test-section">
        <h2>Step 3: Test Game Flow</h2>
        <button onclick="testDirectGameFlow()">Test Game Flow Directly</button>
        <div id="game-flow-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="debug-log" class="log"></div>
    </div>

    <script>
        let logElement = document.getElementById('debug-log');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            logElement.innerHTML = '';
        }
        
        function setStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status ' + type;
            statusEl.textContent = message;
        }
        
        function setupAuth() {
            log('Setting up authentication...');
            setStatus('Setting up authentication...', 'info');
            
            fetch('/quick_login.php')
            .then(response => response.text())
            .then(text => {
                log('Auth setup response: ' + text.substring(0, 100));
                setStatus('Authentication setup complete', 'success');
                document.getElementById('auth-status').innerHTML = 
                    '<div class="success">✓ Authentication ready</div>';
            })
            .catch(error => {
                log('Auth setup error: ' + error.message);
                setStatus('Authentication setup failed: ' + error.message, 'error');
                document.getElementById('auth-status').innerHTML = 
                    '<div class="error">✗ Authentication failed</div>';
            });
        }
        
        function loadGamePage() {
            log('Loading game page in frame...');
            const frame = document.getElementById('game-frame');
            frame.src = '/game.php';
            
            frame.onload = function() {
                log('Game page loaded in frame');
                setStatus('Game page loaded. Check the frame above.', 'success');
            };
            
            frame.onerror = function() {
                log('Error loading game page in frame');
                setStatus('Error loading game page', 'error');
            };
        }
        
        async function testDirectGameFlow() {
            log('Starting direct game flow test...');
            setStatus('Testing complete game flow...', 'info');
            
            try {
                // Step 1: Test authentication
                log('Step 1: Testing authentication...');
                const authResponse = await fetch('/game.php', {
                    method: 'POST',
                    body: new URLSearchParams({ ajax: '1' })
                });
                const authData = await authResponse.json();
                log('Auth test result: ' + JSON.stringify(authData));
                
                if (!authData.success && authData.error === 'Authentication required') {
                    log('Authentication required, setting up auth...');
                    await fetch('/quick_login.php');
                    log('Authentication setup complete');
                }
                
                // Step 2: Start game
                log('Step 2: Starting game...');
                const startResponse = await fetch('/game.php', {
                    method: 'POST',
                    body: new URLSearchParams({
                        action: 'start_game',
                        bet_amount: '100',
                        ajax: '1'
                    })
                });
                
                const startText = await startResponse.text();
                log('Start game response: ' + startText.substring(0, 300));
                
                let startData;
                try {
                    startData = JSON.parse(startText);
                } catch (e) {
                    log('Failed to parse start game response as JSON');
                    document.getElementById('game-flow-result').innerHTML = 
                        '<div class="error">Failed to parse start game response: <pre>' + startText.substring(0, 500) + '</pre></div>';
                    return;
                }
                
                if (startData.success) {
                    log('Game started successfully!');
                    log('Game state: ' + startData.gameState.gameState);
                    log('Can hit: ' + startData.gameState.canHit);
                    log('Can stand: ' + startData.gameState.canStand);
                    
                    // Step 3: Test hit action
                    if (startData.gameState.canHit) {
                        log('Step 3: Testing hit action...');
                        const hitResponse = await fetch('/game.php', {
                            method: 'POST',
                            body: new URLSearchParams({
                                action: 'hit',
                                ajax: '1'
                            })
                        });
                        
                        const hitText = await hitResponse.text();
                        log('Hit response: ' + hitText.substring(0, 200));
                        
                        try {
                            const hitData = JSON.parse(hitText);
                            if (hitData.success) {
                                log('Hit action successful!');
                                setStatus('All tests passed! Game flow is working correctly.', 'success');
                            } else {
                                log('Hit action failed: ' + hitData.error);
                                setStatus('Hit action failed: ' + hitData.error, 'error');
                            }
                        } catch (e) {
                            log('Failed to parse hit response as JSON');
                            setStatus('Hit response parsing failed', 'error');
                        }
                    }
                    
                    document.getElementById('game-flow-result').innerHTML = 
                        '<div class="success">✓ Game flow test completed. Check debug log for details.</div>';
                        
                } else {
                    log('Game start failed: ' + startData.error);
                    setStatus('Game start failed: ' + startData.error, 'error');
                    document.getElementById('game-flow-result').innerHTML = 
                        '<div class="error">Game start failed: ' + startData.error + '</div>';
                }
                
            } catch (error) {
                log('Direct game flow test error: ' + error.message);
                setStatus('Game flow test failed: ' + error.message, 'error');
                document.getElementById('game-flow-result').innerHTML = 
                    '<div class="error">Test failed: ' + error.message + '</div>';
            }
        }
        
        log('Complete test page loaded and ready');
        setStatus('Ready to test. Click "Setup Authentication" first.', 'info');
    </script>
</body>
</html>
