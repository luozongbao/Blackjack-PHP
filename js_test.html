<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Error Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #console-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>JavaScript Error Fix Verification</h1>
    
    <div class="test-container">
        <h2>Test Status</h2>
        <div id="test-status" class="status info">Initializing tests...</div>
    </div>
    
    <div class="test-container">
        <h2>Function Tests</h2>
        <button onclick="testUpdatePlayerHands()">Test updatePlayerHands</button>
        <button onclick="testUpdateDealerHand()">Test updateDealerHand</button>
        <button onclick="testGameActionFlow()">Test Game Action Flow</button>
        <button onclick="testAJAXFlow()">Test AJAX Flow</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>
    
    <div class="test-container">
        <h2>Console Output</h2>
        <div id="console-output"></div>
    </div>

    <script>
        let consoleOutput = document.getElementById('console-output');
        let testStatus = document.getElementById('test-status');
        
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToOutput('LOG: ' + args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logToOutput('ERROR: ' + args.join(' '));
        };
        
        function logToOutput(message) {
            consoleOutput.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        function clearOutput() {
            consoleOutput.textContent = '';
        }
        
        function setStatus(message, type = 'info') {
            testStatus.textContent = message;
            testStatus.className = 'status ' + type;
        }
        
        // Test if BlackjackUI class is available
        function checkClassAvailability() {
            try {
                if (typeof BlackjackUI !== 'undefined') {
                    logToOutput('✓ BlackjackUI class is available');
                    return true;
                } else {
                    logToOutput('✗ BlackjackUI class is not available');
                    return false;
                }
            } catch (e) {
                logToOutput('✗ Error checking BlackjackUI: ' + e.message);
                return false;
            }
        }
        
        function testUpdatePlayerHands() {
            logToOutput('Testing updatePlayerHands function...');
            
            try {
                // Create a mock BlackjackUI instance
                const game = new BlackjackUI();
                
                // Check if updatePlayerHands method exists
                if (typeof game.updatePlayerHands === 'function') {
                    logToOutput('✓ updatePlayerHands method exists');
                    
                    // Test with mock data
                    const mockPlayerHands = [
                        {
                            cards: [
                                { rank: 'A', suit: 'spades', value: 11 },
                                { rank: 'K', suit: 'hearts', value: 10 }
                            ],
                            score: 21,
                            bet: 100,
                            isBlackjack: true,
                            isSoft: false,
                            isSurrendered: false
                        }
                    ];
                    
                    // Create a mock container
                    const mockContainer = document.createElement('div');
                    mockContainer.id = 'player-hands-container';
                    document.body.appendChild(mockContainer);
                    
                    game.updatePlayerHands(mockPlayerHands, 0);
                    
                    if (mockContainer.children.length > 0) {
                        logToOutput('✓ updatePlayerHands successfully created hand elements');
                        setStatus('updatePlayerHands test passed', 'success');
                    } else {
                        logToOutput('✗ updatePlayerHands did not create any elements');
                        setStatus('updatePlayerHands test failed', 'error');
                    }
                    
                    // Clean up
                    document.body.removeChild(mockContainer);
                    
                } else {
                    logToOutput('✗ updatePlayerHands method does not exist');
                    setStatus('updatePlayerHands method missing', 'error');
                }
                
            } catch (e) {
                logToOutput('✗ Error testing updatePlayerHands: ' + e.message);
                setStatus('updatePlayerHands test error: ' + e.message, 'error');
            }
        }
        
        function testUpdateDealerHand() {
            logToOutput('Testing updateDealerHand function...');
            
            try {
                const game = new BlackjackUI();
                
                if (typeof game.updateDealerHand === 'function') {
                    logToOutput('✓ updateDealerHand method exists');
                    
                    // Test with mock data
                    const mockDealerHand = {
                        cards: [
                            { rank: '10', suit: 'clubs', value: 10 },
                            { rank: '7', suit: 'diamonds', value: 7 }
                        ],
                        score: 17,
                        isBlackjack: false
                    };
                    
                    // Create mock elements
                    const mockCards = document.createElement('div');
                    mockCards.id = 'dealer-cards';
                    const mockScore = document.createElement('div');
                    mockScore.id = 'dealer-score';
                    
                    document.body.appendChild(mockCards);
                    document.body.appendChild(mockScore);
                    
                    game.updateDealerHand(mockDealerHand);
                    
                    if (mockCards.children.length > 0 && mockScore.textContent) {
                        logToOutput('✓ updateDealerHand successfully updated dealer display');
                        setStatus('updateDealerHand test passed', 'success');
                    } else {
                        logToOutput('✗ updateDealerHand did not update dealer display');
                        setStatus('updateDealerHand test failed', 'error');
                    }
                    
                    // Clean up
                    document.body.removeChild(mockCards);
                    document.body.removeChild(mockScore);
                    
                } else {
                    logToOutput('✗ updateDealerHand method does not exist');
                    setStatus('updateDealerHand method missing', 'error');
                }
                
            } catch (e) {
                logToOutput('✗ Error testing updateDealerHand: ' + e.message);
                setStatus('updateDealerHand test error: ' + e.message, 'error');
            }
        }
        
        function testGameActionFlow() {
            logToOutput('Testing game action flow...');
            
            try {
                // Test if global functions exist
                if (typeof gameAction === 'function') {
                    logToOutput('✓ gameAction function exists');
                } else {
                    logToOutput('✗ gameAction function missing');
                }
                
                if (typeof newGame === 'function') {
                    logToOutput('✓ newGame function exists');
                } else {
                    logToOutput('✗ newGame function missing');
                }
                
                // Test if window.blackjackGame is initialized
                if (window.blackjackGame && typeof window.blackjackGame.makeGameAction === 'function') {
                    logToOutput('✓ Global blackjackGame instance is available');
                    setStatus('Game action flow test passed', 'success');
                } else {
                    logToOutput('✗ Global blackjackGame instance not available');
                    setStatus('Game action flow test failed', 'error');
                }
                
            } catch (e) {
                logToOutput('✗ Error testing game action flow: ' + e.message);
                setStatus('Game action flow test error: ' + e.message, 'error');
            }
        }
        
        function testAJAXFlow() {
            logToOutput('Testing AJAX flow simulation...');
            
            try {
                const game = new BlackjackUI();
                
                // Test updateGameStateFromResponse with mock data
                const mockResponse = {
                    success: true,
                    gameState: {
                        gameState: 'player_turn',
                        playerHands: [
                            {
                                cards: [
                                    { rank: '8', suit: 'hearts', value: 8 },
                                    { rank: '5', suit: 'spades', value: 5 }
                                ],
                                score: 13,
                                bet: 100,
                                isBlackjack: false,
                                isSoft: false,
                                isSurrendered: false
                            }
                        ],
                        dealerHand: {
                            cards: [
                                { rank: 'Q', suit: 'diamonds', value: 10 },
                                { rank: '?', suit: '?', value: 0 }
                            ],
                            score: 10,
                            isBlackjack: false
                        },
                        currentHandIndex: 0,
                        canHit: true,
                        canStand: true,
                        canDouble: false,
                        canSplit: false,
                        canSurrender: true
                    },
                    sessionData: {
                        current_money: 4900
                    }
                };
                
                // Create required DOM elements
                const elements = [
                    { id: 'player-hands-container', tag: 'div' },
                    { id: 'dealer-cards', tag: 'div' },
                    { id: 'dealer-score', tag: 'div' },
                    { id: 'action-section', tag: 'div' },
                    { class: 'money-display', tag: 'div' }
                ];
                
                const createdElements = [];
                elements.forEach(elem => {
                    const el = document.createElement(elem.tag);
                    if (elem.id) el.id = elem.id;
                    if (elem.class) el.className = elem.class;
                    document.body.appendChild(el);
                    createdElements.push(el);
                });
                
                // Test the response handler
                game.updateGameStateFromResponse(mockResponse);
                
                logToOutput('✓ AJAX response simulation completed without errors');
                setStatus('AJAX flow test passed', 'success');
                
                // Clean up
                createdElements.forEach(el => document.body.removeChild(el));
                
            } catch (e) {
                logToOutput('✗ Error testing AJAX flow: ' + e.message);
                setStatus('AJAX flow test error: ' + e.message, 'error');
            }
        }
        
        // Run initial checks
        window.addEventListener('DOMContentLoaded', function() {
            logToOutput('Starting JavaScript error fix verification...');
            
            if (checkClassAvailability()) {
                setStatus('All JavaScript functions are available', 'success');
                logToOutput('✓ All required functions have been successfully added');
                logToOutput('The "TypeError: this.updatePlayerHands is not a function" error should now be fixed');
            } else {
                setStatus('JavaScript class not available', 'error');
            }
        });
    </script>
    
    <!-- Load the actual game.js file -->
    <script src="assets/js/game.js"></script>
</body>
</html>
