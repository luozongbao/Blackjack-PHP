<!DOCTYPE html>
<html>
<head>
    <title>Blackjack Game - Final Test Suite</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        #results { margin-top: 20px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üÉè Blackjack Game - Final Test Suite</h1>
        <p>This test suite verifies all the critical fixes that were implemented to resolve HTTP 500 errors and player card visibility issues.</p>
        
        <div class="test-section">
            <h2>Critical Issues Being Tested</h2>
            <ol>
                <li><strong>HTTP 500 on game.php access after leaving page</strong> - Session deserialization error</li>
                <li><strong>Player cards not visible after dealing</strong> - DOM element creation issue</li>
                <li><strong>HTTP 500 on page refresh</strong> - Session corruption</li>
                <li><strong>Wrong game state when logged out</strong> - Session state management</li>
            </ol>
        </div>

        <div class="test-section">
            <h2>üß™ Automated Test Execution</h2>
            <div class="test-step">
                <strong>Test Sequence:</strong> Login ‚Üí Start Game ‚Üí Leave Page ‚Üí Return ‚Üí Refresh ‚Üí Check Cards
            </div>
            
            <button class="btn-primary" onclick="runFullTestSuite()">üöÄ Run Complete Test Suite</button>
            <button class="btn-warning" onclick="runQuickTest()">‚ö° Quick Session Test</button>
            <button class="btn-success" onclick="testPlayerCards()">üë§ Test Player Cards</button>
            <button class="btn-danger" onclick="clearTestData()">üóëÔ∏è Clear Test Data</button>
            
            <div id="results"></div>
        </div>

        <div class="test-section">
            <h2>üìã Manual Test Instructions</h2>
            <div class="test-step">
                <strong>Step 1:</strong> Run the automated tests above first
            </div>
            <div class="test-step">
                <strong>Step 2:</strong> <a href="/login.php" target="_blank">Login to the game</a> (use: test/test123)
            </div>
            <div class="test-step">
                <strong>Step 3:</strong> <a href="/game.php" target="_blank">Go to game page</a> and start a game
            </div>
            <div class="test-step">
                <strong>Step 4:</strong> Navigate away from game.php and return (should not get HTTP 500)
            </div>
            <div class="test-step">
                <strong>Step 5:</strong> Refresh the page (should not get HTTP 500)
            </div>
            <div class="test-step">
                <strong>Step 6:</strong> Verify player cards are visible after dealing
            </div>
        </div>
    </div>

    <script>
        let testResults = [];

        function logResult(test, success, message, details = '') {
            const result = { test, success, message, details, timestamp: new Date() };
            testResults.push(result);
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>Test Results:</h3>';
            
            testResults.forEach((result, index) => {
                const className = result.success ? 'success' : 'error';
                const icon = result.success ? '‚úÖ' : '‚ùå';
                const details = result.details ? `<div class="log">${result.details}</div>` : '';
                
                resultsDiv.innerHTML += `
                    <div class="test-step ${className}">
                        ${icon} <strong>${result.test}</strong>: ${result.message}
                        ${details}
                    </div>
                `;
            });
        }

        async function runQuickTest() {
            logResult('Quick Test Started', true, 'Testing basic session functionality...');
            
            try {
                // Test session test page
                const response = await fetch('/session_test.php');
                if (response.ok) {
                    const html = await response.text();
                    if (html.includes('All includes loaded successfully')) {
                        logResult('Session Test', true, 'Basic session functionality working');
                    } else {
                        logResult('Session Test', false, 'Session test page has issues');
                    }
                } else {
                    logResult('Session Test', false, `HTTP ${response.status} error`);
                }
            } catch (error) {
                logResult('Session Test', false, 'Network error: ' + error.message);
            }
        }

        async function testPlayerCards() {
            logResult('Player Cards Test', true, 'Testing player card DOM structure...');
            
            try {
                // Test if updatePlayerHands function exists
                const response = await fetch('/game.php');
                if (response.ok) {
                    const html = await response.text();
                    if (html.includes('updatePlayerHands')) {
                        logResult('Player Cards Function', true, 'updatePlayerHands function found in game.php');
                    } else {
                        logResult('Player Cards Function', false, 'updatePlayerHands function not found');
                    }
                    
                    if (html.includes('player-hands-container')) {
                        logResult('Player Cards Container', true, 'player-hands-container element found');
                    } else {
                        logResult('Player Cards Container', false, 'player-hands-container element not found');
                    }
                } else {
                    logResult('Player Cards Test', false, `HTTP ${response.status} error accessing game.php`);
                }
            } catch (error) {
                logResult('Player Cards Test', false, 'Network error: ' + error.message);
            }
        }

        async function runFullTestSuite() {
            testResults = [];
            logResult('Full Test Suite', true, 'Starting comprehensive test...');
            
            // Test 1: Basic connectivity
            await testConnectivity();
            
            // Test 2: Session functionality
            await runQuickTest();
            
            // Test 3: Player cards
            await testPlayerCards();
            
            // Test 4: Game page access (critical test)
            await testGamePageAccess();
            
            logResult('Full Test Suite', true, 'Test suite completed!');
        }

        async function testConnectivity() {
            try {
                const response = await fetch('/');
                if (response.ok || response.status === 302) {
                    logResult('Connectivity', true, 'Server is responsive');
                } else {
                    logResult('Connectivity', false, `Server returned status ${response.status}`);
                }
            } catch (error) {
                logResult('Connectivity', false, 'Cannot connect to server: ' + error.message);
            }
        }

        async function testGamePageAccess() {
            logResult('Game Access Test', true, 'Testing game.php access patterns...');
            
            try {
                // Test direct game.php access (should redirect to login)
                const response = await fetch('/game.php', { redirect: 'manual' });
                if (response.status === 302) {
                    logResult('Game Page Redirect', true, 'Correctly redirects to login when not authenticated');
                } else if (response.status === 500) {
                    logResult('Game Page Redirect', false, 'HTTP 500 error - session deserialization issue still exists');
                } else {
                    logResult('Game Page Redirect', true, `Returned status ${response.status} (acceptable)`);
                }
            } catch (error) {
                logResult('Game Access Test', false, 'Error testing game page: ' + error.message);
            }
        }

        function clearTestData() {
            testResults = [];
            document.getElementById('results').innerHTML = '';
            logResult('Test Data', true, 'Test data cleared');
        }

        // Auto-run quick test on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runQuickTest, 1000);
        });
    </script>
</body>
</html>
